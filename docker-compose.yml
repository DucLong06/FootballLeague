services:
    frontend_builder:
        build:
            context: ./frontend
            dockerfile: Dockerfile
            args:
                VITE_API_URL: ${VITE_API_URL}
        volumes:
            - frontend_build:/app/dist
        command: echo "Frontend built successfully"
        networks:
            - app_network

    db:
        image: postgres:15-alpine
        restart: always
        ports:
            - "5432:5432"
        volumes:
            - postgres_data_prod:/var/lib/postgresql/data
            - ./backups:/backups
        environment:
            - POSTGRES_DB=${POSTGRES_DB}
            - POSTGRES_USER=${POSTGRES_USER}
            - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
        networks:
            - app_network
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7-alpine
        restart: always
        volumes:
            - redis_data_prod:/data
        networks:
            - app_network

    backend:
        build:
            context: ./backend
            dockerfile: Dockerfile
        restart: always
        command: >
            sh -c "python manage.py migrate &&
                   python manage.py collectstatic --noinput &&
                   gunicorn core.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 120"
        volumes:
            - frontend_build:/app/frontend_build
            - static_volume_prod:/app/staticfiles
            - media_volume_prod:/app/media
            - logs_volume_prod:/app/logs
        ports:
            - "80:8000"
        env_file:
            - .env
        networks:
            - app_network
        depends_on:
            - frontend_builder
            - db
            - redis

    celery_worker:
        build:
            context: ./backend
        restart: always
        command: celery -A core worker -l info --concurrency=1
        volumes:
            - logs_volume_prod:/app/logs
        env_file:
            - .env
        depends_on:
            - backend
        networks:
            - app_network

    celery_beat:
        build:
            context: ./backend
        restart: always
        command: celery -A core beat -l info
        volumes:
            - logs_volume_prod:/app/logs
        env_file:
            - .env
        depends_on:
            - backend
        networks:
            - app_network

volumes:
    frontend_build:
    static_volume_prod:
    media_volume_prod:
    logs_volume_prod:
    postgres_data_prod:
    redis_data_prod:

networks:
    app_network:
        driver: bridge
